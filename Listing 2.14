--Analyse von ABAP–Code in SAP-BW-Transformationen mit Table Function MY_TABLE_FUNCTION
FUNCTION "MEIN_SCHEMA"."MEIN_PAKET::MY_TABLE_FUNCTION" ( 
IN LV_IOBJ NVARCHAR (72), --gesuchtes Objekt, z. B. DSO Name
IN LV_TRFN NVARCHAR (32),  --gesuchte Transformation
IN LV_IN_TRFN NVARCHAR (1)) --Soll nur in TRFN gesucht werden
--Deklaration der Rückgabetabelle
RETURNS TABLE (
"TRANID" NVARCHAR (32),
 "STARTROUTINE" NVARCHAR (25),
 "ENDROUTINE" NVARCHAR (25),
 "EXPERT" NVARCHAR (25),
 "CODEID" NVARCHAR (25),
 "LINE" NVARCHAR (72),
 "LINE_NO" NVARCHAR (6),
 "COUNTER" BIGINT
 )
       
LANGUAGE SQLSCRIPT
SQL SECURITY INVOKER
DEFAULT SCHEMA LHT_OBJECTS AS 

 BEGIN 
 
/***************************** 
   Lesen des TRFN-Quellcode aus Tabelle RSAABAP
 *****************************/
--Wildcard für LIKE-Vergleich unten im Code
LV_IOBJ := '%' ||LV_IOBJ|| '%'; 

--Abfrage, ob Transformation oder Objekt
if LV_IN_TRFN = 'X' THEN

return --Rückgabe der Werte in Tabellenform

     select   
        TRFN."TRANID"       as "TRANID", 
        TRFN."STARTROUTINE" as "STARTROUTINE", 
        TRFN."ENDROUTINE"   as "ENDROUTINE", 
        TRFN."EXPERT"       as "EXPERT", 
        CODE."CODEID"       as "CODEID", 
        CODE."LINE"         as "LINE", 
        CODE."LINE_NO"      as "LINE_NO",
        TRFN."VERSION_CUR"  as "COUNTER" 
        
    from "RSTRAN" as "TRFN" 
--Tabelle aller Transformationen
      INNER JOIN  "RSAABAP"  as "CODE" 
--Tabelle ABAP-Code
        on
            CODE."CODEID" = TRFN."STARTROUTINE" or
            CODE."CODEID" = TRFN."ENDROUTINE" or
            CODE."CODEID" = TRFN."EXPERT"
    
        WHERE TRFN."OBJVERS"  = 'A'
              and CODE."LINE" like LV_IOBJ  
              and TRFN."TRANID" like LV_TRFN;

else 

return 
     select   
        TRFN."TRANID"       as "TRANID", 
        TRFN."STARTROUTINE" as "STARTROUTINE", 
        TRFN."ENDROUTINE"   as "ENDROUTINE" , 
        TRFN."EXPERT"       as "EXPERT", 
        CODE."CODEID"       as "CODEID", 
        CODE."LINE"         as "LINE", 
        CODE."LINE_NO"      as "LINE_NO",
        TRFN."VERSION_CUR"  as "COUNTER" 
        
    from  "RSAABAP" as "CODE" 
      LEFT OUTER JOIN "RSTRAN" as "TRFN"
        on
            CODE."CODEID" = TRFN."STARTROUTINE" or
            CODE."CODEID" = TRFN."ENDROUTINE"  or
            CODE."CODEID" = TRFN."EXPERT"
    
        WHERE  CODE."OBJVERS"  = 'A'
              and CODE."LINE" like LV_IOBJ  ;
          
 end if;
END;
